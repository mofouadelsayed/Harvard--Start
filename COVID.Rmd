---
title: "COVID"
author: "Mohamed Elsayed"
date: "21/09/2021"
output:
  html_document:
    df_print: paged
---


```{r message=FALSE, warning=FALSE}
if(!require(tidyverse)) install.packages("tidyverse", repos = "http://cran.us.r-project.org")
if(!require(ggplot2)) install.packages("ggplot2", repos = "http://cran.us.r-project.org")
if(!require(scales)) install.packages("scales", repos = "http://cran.us.r-project.org")
if(!require(ggpubr)) install.packages("ggpubr", repos = "http://cran.us.r-project.org")
if(!require(ggrepel)) install.packages("ggrepel", repos = "http://cran.us.r-project.org")
if(!require(caret)) install.packages("caret", repos = "http://cran.us.r-project.org")
if(!require(Amelia)) install.packages("Amelia", repos = "http://cran.us.r-project.org")
if(!require(gcookbook)) install.packages("gcookbook", repos = "http://cran.us.r-project.org")
if(!require(CatEncoders)) install.packages("CatEncoders", repos = "http://cran.us.r-project.org")
if(!require(cleandata)) install.packages("cleandata", repos = "http://cran.us.r-project.org")
if(!require(caTools)) install.packages("caTools", repos = "http://cran.us.r-project.org")
if(!require(ROSE)) install.packages("ROSE", repos = "http://cran.us.r-project.org")
if(!require(party)) install.packages("party", repos = "http://cran.us.r-project.org")
```


```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(ggplot2)
library(scales)
library(ggpubr)
library(ggrepel)
library(caret)
library(Amelia)
library(gcookbook)
library(CatEncoders)
library(cleandata)
library(caTools)
library(ROSE)
library(party)
```

```{r}
# Save R file: saveRDS(x, "x.rds")
# Load R file: x<- readRDS("x.rds")

# Save Environment: save.image("Final.Rdata")
# Load Environment: load("Final.Rdata")
```

- Load file from GitHub
```{r}
# Upload file to Github & enter link below
covid_alberta <- read_csv("https://raw.githubusercontent.com/mofouadelsayed/Harvard.Capstone/main/covid-19-alberta-statistics-data.csv")
```

- Data Exploration
```{r}
# Rename Columns
colnames(covid_alberta)<- c("Number", "Date", "Zone", "Gender", "Age_group", "Status", "Type")

# Exclude Unkown entries
covid_alberta<- covid_alberta %>% filter(!Age_group== "Unknown") %>% filter(!Gender== "Unknown") %>% filter(!Status== "Active")

# Daily cases clearly showing the pandemic waves
daily_cases<-covid_alberta %>% group_by(Date) %>% summarize(Cases= n())
daily_cases %>% ggplot(aes(Date, Cases)) + geom_line()

# Cases by Age group & Gender
within(covid_alberta, Age_group <- factor(Age_group, levels=names(sort(table(Age_group), decreasing=TRUE)))) %>% ggplot(aes(Age_group,fill=Gender)) + geom_bar() + theme(axis.text.x = element_text(angle=90, hjust=1)) + geom_label(stat='count',aes(label=..count..), size=3,position=position_stack(vjust = 0.5))

# Case status by Age Group
covid_alberta %>% ggplot(aes(Age_group,fill=Status)) + geom_bar() + theme(axis.text.x = element_text(angle=90, hjust=1)) + geom_label(stat='count',aes(label=..count..), size=3,position=position_stack(vjust = 0.5))

# Status by Gender
covid_alberta %>% ggplot(aes(Gender,fill=Status)) + geom_bar() +  scale_y_continuous(labels = comma) + geom_label(stat='count',aes(label=..count..), size=3,position=position_stack(vjust = 0.5)) + theme_minimal()

# Death by Gender
covid_alberta %>% filter(Status== "Died") %>% ggplot(aes(Gender,fill=Status)) + geom_bar() +  scale_y_continuous(labels = comma) + geom_label(stat='count',aes(label=..count..), size=3,position="stack") + theme_minimal()

# Death by Gender & Age group
covid_alberta %>% filter(Status== "Died") %>% ggplot(aes(Age_group,fill=Gender)) + geom_bar() +  scale_y_continuous(labels = comma) + geom_label(stat='count',aes(label=..count..), size=3,position="stack") + theme_minimal()

# Cases by Zones
covid_alberta %>% count(Zone) %>% ggplot(aes(reorder(Zone, -n), n)) + geom_bar(stat= "identity")

# Deaths by Zone
covid_alberta %>% filter(Status=="Died") %>% count(Zone) %>% ggplot(aes(reorder(Zone, -n), n)) + geom_bar(stat= "identity")
```

- Data Preparation
```{r message=FALSE, warning=FALSE}
str(covid_alberta)

# Converting the Type, Status & Gender variables to factors to be able to feed them into the model.
covid_alberta$Type<-  factor(covid_alberta$Type,
                 levels = c('Confirmed', 'Probable'),
                 labels = c(1, 0))

covid_alberta$Status<-  factor(covid_alberta$Status,
                   levels = c('Recovered','Died'),
                   labels = c(0, 1))

covid_alberta$Gender<- factor(covid_alberta$Gender,
                   levels = c('Male', 'Female'),
                   labels = c(1, 0))

covid_alberta$Age_group<- factor(covid_alberta$Age_group, 
                      levels = c('Under 1 year','1-4 years','5-9 years',
                                 '10-19 years','20-29 years',
                                 '30-39 years','40-49 years','50-59 years','60-69 years',
                                 '70-79 years','80+ years'),
                      labels = c(0,1,2,3,4,5,6,7,8,9,10))

# Converting Zones by dummyVars
covid_alberta$Zone<- factor(covid_alberta$Zone, exclude = NULL)
covid_alberta$Zone<- addNA(covid_alberta$Zone)
dummy<- caret::dummyVars("~Zone", data= covid_alberta)
df<- data.frame(predict(dummy, newdata = covid_alberta))
covid_alberta<- cbind(covid_alberta, df)

# Removing the Zone Column as replaced by the dummyVars outpput
covid_alberta<- covid_alberta %>% select(c(-Zone, -Date, -Number))

# Creating the train & test sets
set.seed(123, sample.kind = "Rounding")
ind<- createDataPartition(covid_alberta$Status, times= 1, p=0.7, list= FALSE)
train<- covid_alberta[ind,]
test<- covid_alberta[-ind,]
```

- Since deaths in COVID cases represent only about <1% of the recovered cases, data is extremely unbalanced. I will create the model initially with the data as it is then will try to increase the model accuracy & sensitivity by balancing the data.

- 1: Unbalanced glm model
```{r message=FALSE, warning=FALSE}
unbal_glm_fit<- train %>% glm(Status ~ ., data=., family = "binomial")
unbal_glm_pred<- ifelse(predict(unbal_glm_fit, newdata = test, type = "response") >0.5, 1, 0)
# Confusion matrix resulting in very high inaccurate Accuracy as more than 99% of the case status is recovered "0". It's very visible as sensitivity is 0. We can try to fix this using over sampling to try to balance the data for better training of the model.
confusionMatrix(as.factor(unbal_glm_pred), test$Status, positive = "1")

Accuracy_results <- tibble(Method = "Unbalanced glm", Accuracy = confusionMatrix(as.factor(unbal_glm_pred), test$Status, positive = "1")$byClass["Balanced Accuracy"]) 
Accuracy_results
```

- 2: Balanced glm model using over-sampling
```{r message=FALSE, warning=FALSE}
over<- ovun.sample(Status ~ ., data=train, method = "over", N= 412762)$data
table(over$Status)

bal_glm_fit_over<- over %>% glm(Status ~ ., data=., family = "binomial")
bal_glm_pred_over<- ifelse(predict(bal_glm_fit_over, newdata = test, type = "response") >0.5, 1, 0)

confusionMatrix(as.factor(bal_glm_pred_over), test$Status, positive = "1")

Accuracy_results <- bind_rows(Accuracy_results, tibble(Method = "Balanced Over-sampling glm", Accuracy = confusionMatrix(as.factor(bal_glm_pred_over), test$Status, positive = "1")$byClass["Balanced Accuracy"])) 

Accuracy_results %>% knitr::kable()
```

- 3: Balanced glm model using under-sampling (No difference from Over-sampling)
```{r message=FALSE, warning=FALSE}
under<- ovun.sample(Status~ ., data= train, method = "under", N= 4060)$data
table(under$Status)
bal_glm_fit_under<- under %>% glm(Status ~ ., data=., family = "binomial")
bal_glm_pred_under<- ifelse(predict(bal_glm_fit_under, newdata = test, type = "response") >0.5, 1, 0)

confusionMatrix(as.factor(bal_glm_pred_under), test$Status, positive = "1")

Accuracy_results <- bind_rows(Accuracy_results, tibble(Method = "Under-Balanced glm", Accuracy = confusionMatrix(as.factor(bal_glm_pred_under), test$Status, positive = "1")$byClass["Balanced Accuracy"])) 

Accuracy_results %>% knitr::kable()
```

- Ctree: Unbalanced
```{r}
tree<- train %>% ctree(Status ~ ., data=.)
tree_pred<- predict(tree, test)

confusionMatrix(tree_pred, test$Status, positive = "1")

Accuracy_results <- bind_rows(Accuracy_results, tibble(Method = "Unbalanced Ctree", Accuracy = confusionMatrix(tree_pred, test$Status, positive = "1")$byClass["Balanced Accuracy"])) 

Accuracy_results %>% knitr::kable()
```

- Ctree Balanced Under-Sampling
```{r}
under_tree<- ovun.sample(Status~ ., data= train, method = "under", N= 4060)$data
bal_ctree<- under_tree %>% ctree(Status ~ ., data=.)
bal_ctree_pred<- predict(bal_ctree, test)

confusionMatrix(bal_ctree_pred, test$Status, positive = "1")

Accuracy_results <- bind_rows(Accuracy_results, tibble(Method = "Under-Balanced Ctree", Accuracy = confusionMatrix(bal_ctree_pred, test$Status, positive = "1")$byClass["Balanced Accuracy"])) 

Accuracy_results %>% knitr::kable()
```

- Cross Validation Unbalanced
```{r message=FALSE, warning=FALSE}
set.seed(8, sample.kind = "Rounding")
control<- trainControl(method = "cv", number= 10, verboseIter = TRUE)
glm_cross<- train(Status ~ ., method= "glm", data= train, trControl=control)
glm_cross_pred<- predict(glm_cross, test)

confusionMatrix(glm_cross_pred, test$Status, positive = "1")

Accuracy_results <- bind_rows(Accuracy_results, tibble(Method = "Cross-Validation Unbalanced glm", Accuracy = confusionMatrix(glm_cross_pred, test$Status, positive = "1")$byClass["Balanced Accuracy"])) 

Accuracy_results %>% knitr::kable()
```

- Cross Validation Under-Balanced
```{r message=FALSE, warning=FALSE}
control<- trainControl(method = "cv", number= 10, verboseIter = TRUE)
set.seed(8, sample.kind = "Rounding")
glm_cross_under<- train(Status ~ ., method= "glm", data= under_tree, trControl=control)
glm_cross_under_pred<- predict(glm_cross_under, test)

confusionMatrix(glm_cross_under_pred, test$Status, positive = "1")

Accuracy_results <- bind_rows(Accuracy_results, tibble(Method = "Cross-Validation Under- Balanced glm", Accuracy = confusionMatrix(glm_cross_under_pred, test$Status, positive = "1")$byClass["Balanced Accuracy"])) 

Accuracy_results %>% knitr::kable()
```

